generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("user") // "user", "therapist", "admin", "superadmin"
  isTherapist   Boolean   @default(false)
  isAdmin       Boolean   @default(false)
  isSuperAdmin  Boolean   @default(false)
  isOnline      Boolean   @default(false)
  lastActiveAt  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Stripe integration
  stripeCustomerId  String?   @unique
  stripeAccountId   String?   @unique

  sessions      Session[]
  journalEntries JournalEntry[]
  biomarkers    Biomarker[]
  biomarkerGoals BiomarkerGoal[]
  biomarkerBaselines BiomarkerBaseline[]
  biomarkerAlerts BiomarkerAlert[]
  personas      CustomPersona[]
  personaConversations PersonaConversation[]
  therapistProfile TherapistProfile?
  therapySessions TherapySession[] @relation("UserSessions")
  therapistSessions TherapySession[] @relation("TherapistSessions")

  // New relations
  notifications       Notification[]
  availabilitySlots   TherapistAvailability[]
  aiTherapySessions   AITherapySession[]
  userPayments        Payment[] @relation("UserPayments")
  therapistPayments   Payment[] @relation("TherapistPayments")
  studentConversations  ChatConversation[] @relation("StudentConversations")
  therapistConversations ChatConversation[] @relation("TherapistConversations")

  // Journal relations
  journalSessions     JournalSession[]
  journalStreak       JournalStreak?
}

model Session {
  id              String              @id @default(cuid())
  userId          String
  duration        Int                 // in seconds
  calmScore       Float               // 0-100
  notes           String?
  dominantMood    String?             // Overall session mood
  moodChanges     Int?                // Number of significant mood shifts
  emotionalScore  Float?              // 0-100, emotional stability
  createdAt       DateTime            @default(now())
  
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentiments      SentimentSnapshot[]
}

model JournalEntry {
  id              String   @id @default(cuid())
  userId          String
  sessionId       String?
  title           String?
  content         String
  mood            Int?
  moodAfter       Int?
  distortion      String?
  distortions     String?
  socraticPrompt  String?
  userResponse    String?
  tags            String?
  isVoiceEntry    Boolean  @default(false)
  audioUrl        String?
  aiSummary       String?
  gratitudeItems  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         JournalSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
}

model JournalSession {
  id          String   @id @default(cuid())
  userId      String
  sessionType String
  title       String?
  summary     String?
  moodStart   Int?
  moodEnd     Int?
  messages    String   @default("[]")
  isComplete  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries     JournalEntry[]
}

model JournalStreak {
  id            String    @id @default(cuid())
  userId        String    @unique
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastEntryDate DateTime?
  totalEntries  Int       @default(0)
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model JournalPrompt {
  id            String   @id @default(cuid())
  category      String
  prompt        String
  isAIGenerated Boolean  @default(false)
  usageCount    Int      @default(0)
  createdAt     DateTime @default(now())
}

model Biomarker {
  id               String   @id @default(cuid())
  userId           String
  date             DateTime @default(now())

  // Core metrics
  pitch            Float    // Hz - fundamental frequency
  clarity          Float    // 0-100 - articulation quality
  stress           Float    // 0-100 - tension indicators

  // Extended metrics
  pauseDuration    Float?   // seconds - average pause length
  articulationRate Float?   // words per second
  jitter           Float?   // % - frequency variation (vocal cord health)
  shimmer          Float?   // % - amplitude variation (breath support)
  speechRate       Float?   // words per minute
  hnr              Float?   // dB - harmonic-to-noise ratio (voice quality)

  // Session metadata
  duration         Int?     // recording duration in seconds
  audioUrl         String?  // stored audio file URL/path
  prompt           String?  // reading prompt or "free_speech"
  notes            String?  // user notes

  // Computed scores
  overallScore     Float?   // AI-computed health score 0-100
  observations     String?  // AI observations (JSON)
  recommendations  String?  // AI recommendations (JSON array)

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model BiomarkerGoal {
  id        String   @id @default(cuid())
  userId    String
  metric    String   // "pitch", "clarity", "stress", etc.
  target    Float
  direction String   @default("maintain") // "increase", "decrease", "maintain"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metric])
}

model BiomarkerBaseline {
  id               String   @id @default(cuid())
  userId           String

  // Baseline values for each metric
  pitch            Float
  pitchStdDev      Float?   // standard deviation
  clarity          Float
  clarityStdDev    Float?
  stress           Float
  stressStdDev     Float?
  pauseDuration    Float?
  articulationRate Float?
  jitter           Float?
  shimmer          Float?
  speechRate       Float?
  hnr              Float?

  recordingCount   Int      // how many recordings used to calculate
  calculatedAt     DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BiomarkerAlert {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "critical", "warning", "reminder", "achievement"
  metric      String?  // which metric triggered (if applicable)
  title       String
  message     String
  value       Float?   // the triggering value
  threshold   Float?   // the threshold crossed
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CustomPersona {
  id                String   @id @default(cuid())
  userId            String
  name              String
  description       String
  icon              String   @default("âœ¨")
  voiceId           String?  // ElevenLabs voice ID
  voiceStability    Float    @default(0.5)    // 0-1
  voiceSimilarity   Float    @default(0.8)    // 0-1
  voiceStyle        Float    @default(0.0)    // 0-1
  voiceSpeakerBoost Boolean  @default(true)
  speechRate        Float    @default(1.0)    // 0.5-2.0
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations     PersonaConversation[]
}

model PersonaConversation {
  id          String   @id @default(cuid())
  userId      String
  personaId   String?  // Can be preset ID (p1, p2) or custom persona ID, nullable for deleted personas
  personaName String   // Store name for history
  personaIcon String   // Store icon for history
  messages    String   // JSON array of { role, content, timestamp }
  summary     String?  // AI-generated summary
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona     CustomPersona? @relation(fields: [personaId], references: [id], onDelete: SetNull)
}

model SentimentSnapshot {
  id          String   @id @default(cuid())
  sessionId   String
  timestamp   Int      // seconds into session
  sentiment   String   // "positive", "neutral", "negative", "anxious", "calm"
  intensity   Float    // 0-1
  emotions    String   // JSON string: {"happy": 0.2, "sad": 0.1, ...}
  aiInsight   String?  // Optional AI comment
  createdAt   DateTime @default(now())
  
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model TherapistProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  bio             String?
  specializations String?  // JSON array: ["anxiety", "depression", "trauma"]
  availability    String?  // JSON object: {"monday": ["09:00-17:00"], ...}
  hourlyRate      Float?   // in USD
  isApproved      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TherapySession {
  id              String   @id @default(cuid())
  userId          String   // Client
  therapistId     String   // Therapist
  scheduledAt     DateTime
  duration        Int      @default(60) // minutes
  status          String   @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  notes           String?  // Therapist notes
  userNote        String?  // User's initial note when booking
  actualStartTime DateTime?
  actualEndTime   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  therapist       User     @relation("TherapistSessions", fields: [therapistId], references: [id], onDelete: Cascade)

  // New relations
  preSessionData      PreSessionData?
  recordings          SessionRecording[]
  postSessionSummary  PostSessionSummary?
  payments            Payment[]
}

model ChatConversation {
  id              String    @id @default(cuid())
  studentId       String
  therapistId     String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  student         User      @relation("StudentConversations", fields: [studentId], references: [id], onDelete: Cascade)
  therapist       User      @relation("TherapistConversations", fields: [therapistId], references: [id], onDelete: Cascade)
  messages        ChatMessage[]

  @@unique([studentId, therapistId])
}

model ChatMessage {
  id              String           @id @default(cuid())
  conversationId  String
  senderId        String
  content         String
  isRead          Boolean          @default(false)
  createdAt       DateTime         @default(now())

  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

// ============================================
// NEW MODELS FOR THERAPY SESSION SYSTEM
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // session_reminder, therapist_joined, new_message, session_cancelled, session_starting
  title     String
  message   String
  data      String?  // JSON for additional context (sessionId, etc.)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PreSessionData {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  moodRating      Int      // 1-10
  concernText     String?  // "What's on your mind today?"
  voiceNoteUrl    String?  // Path to pre-session voice note
  sessionGoals    String?  // Goals for this session
  techCheckPassed Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  session         TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model SessionRecording {
  id               String   @id @default(cuid())
  sessionId        String
  filePath         String   // /uploads/recordings/{sessionId}/{filename}
  duration         Int      // seconds
  fileSize         Int?     // bytes
  transcriptPath   String?  // Path to transcript JSON file
  userConsent      Boolean  @default(false)
  therapistConsent Boolean  @default(false)
  createdAt        DateTime @default(now())

  session          TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model PostSessionSummary {
  id               String   @id @default(cuid())
  sessionId        String   @unique
  aiHighlights     String?  // JSON array of highlights
  keyTopics        String?  // JSON array of topics discussed
  homework         String?  // JSON array of action items
  moodBefore       Int?     // From PreSessionData
  moodAfter        Int?     // Post-session mood rating
  rating           Int?     // 1-5 star rating
  feedbackCategories String? // JSON: {"helpfulness": true, "connection": true, ...}
  feedbackText     String?  // Open-ended feedback
  pdfUrl           String?  // Path to generated PDF
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  session          TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model TherapistAvailability {
  id              String    @id @default(cuid())
  therapistId     String
  dayOfWeek       Int       // 0-6 (Sunday-Saturday)
  startTime       String    // "09:00" (24-hour format)
  endTime         String    // "17:00"
  isRecurring     Boolean   @default(true)
  specificDate    DateTime? // For non-recurring (specific dates)
  isBlocked       Boolean   @default(false) // For vacation/unavailable days
  sessionDuration Int       @default(60) // 30, 45, 60 minutes
  bufferTime      Int       @default(15) // minutes between sessions
  maxSessionsPerDay Int?    // Optional limit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  therapist       User      @relation(fields: [therapistId], references: [id], onDelete: Cascade)
}

model AITherapySession {
  id               String    @id @default(cuid())
  userId           String
  personaType      String    // empathetic_listener, cbt_practitioner, mindfulness_guide, solution_focused
  status           String    @default("active") // active, completed, interrupted
  recordingConsent Boolean   @default(false)
  audioRecordingUrl String?  // Optional path to full session recording
  startedAt        DateTime  @default(now())
  endedAt          DateTime?
  durationSeconds  Int?

  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages         AITherapyMessage[]
  summary          AISessionSummary?
  crisisEvents     CrisisEvent[]
}

model AITherapyMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // user, assistant
  content   String   // Transcript text
  audioUrl  String?  // Optional audio storage path
  timestamp Int      // Seconds into session
  sentiment String?  // Detected sentiment
  intensity Float?   // 0-1
  createdAt DateTime @default(now())

  session   AITherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model AISessionSummary {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  keyTopics       String   // JSON array of topics
  insights        String   // JSON array of insights
  homework        String?  // JSON array of suggested tasks
  moodProgression String   // JSON: {start, middle, end, trend}
  overallSentiment String? // positive, mixed, negative
  therapeuticNotes String? // AI-generated professional notes
  createdAt       DateTime @default(now())

  session         AITherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model CrisisEvent {
  id            String    @id @default(cuid())
  sessionId     String
  detectedAt    DateTime  @default(now())
  triggerPhrase String    // The phrase that triggered detection
  riskLevel     String    // low, medium, high, critical
  category      String?   // suicidal_ideation, self_harm, harm_to_others, severe_distress
  actionTaken   String    // helpline_displayed, therapist_alerted, session_paused
  resolved      Boolean   @default(false)
  resolvedAt    DateTime?
  notes         String?   // Follow-up notes

  session       AITherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Payment {
  id                    String   @id @default(cuid())
  sessionId             String?  // Optional - can be subscription payment
  userId                String   // Payer (client)
  therapistId           String?  // Payee (therapist) - null for AI session subscriptions
  amount                Float    // Amount in cents
  currency              String   @default("usd")
  status                String   // pending, succeeded, failed, refunded
  stripePaymentIntentId String?  @unique
  stripeTransferId      String?  // For therapist payout
  type                  String   // session, subscription, refund
  description           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation("UserPayments", fields: [userId], references: [id])
  therapist             User?    @relation("TherapistPayments", fields: [therapistId], references: [id])
  session               TherapySession? @relation(fields: [sessionId], references: [id])
}

model TherapistAISuggestion {
  id               String   @id @default(cuid())
  therapySessionId String   // References TherapySession (human therapist sessions)
  timestamp        Int      // Seconds into session
  suggestionType   String   // observation, technique, topic_exploration, warning
  content          String
  priority         String   @default("medium") // low, medium, high
  isUsed           Boolean  @default(false)
  createdAt        DateTime @default(now())
}
